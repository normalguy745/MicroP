.INCLUDE "M32DEF.INC"
.DEF COUNTER = R17
.DEF LEDS = R18

;RESET TABLE
.ORG 0x00
JMP INITIALIZE

;EXTERNAL INTERRUPT 1
.ORG 0x04
JMP EXTERNAL_INTERUPT

;TIMER1 OVERFLOW INTERUPT
.ORG 0x12
JMP TIMER1_INTERUPT

;INITIALIZATION
.ORG 0x100

INITIALIZE:
;STACK
LDI R16, HIGH (RAMEND)
OUT SPH, R16
LDI R16, LOW (RAMEND)
OUT SPL, R16

;IO
LDI R16, 0xFF   ;SET ALL HIGH (OUTPUT)
OUT DDRC, R16
CLR LEDS

;INTERUPTS AND TIMERS
CBI DDRD, 3 ;PORTD.3 AS INPUT 

LDI R16, 0x08   ; INT1 AS FALLING EDGE INTERUPT
OUT MCUCR R16
LDI R16, 0x80   ;GICR ENABLE INT1
OUT GICR, R16

;TIMER1
LDI R16, 0b00000100 ;SET TIMSK FOR TIMER1 OVERFLOW
OUT TIMSK, R16

;START TIMER1
CLR R16
OUT TCNT1H, R16     ;START TIMING FROM 0
OUT TCNT1L, R16
LDI R16, 0b00000000 ;TCCR1A NORMAL MODE
OUT TCCR1A, R16
LDI R16, 0b00000001; NORMALMODE, NO PRESCALE
OUT TCCR1B, R16

;ENABLE INTERUPTS
SEI

MAIN:
INC COUNTER
MOV R19, COUNTER   ;COPY COUNTER
ANDI R19, 0b00011111 ;  MASK UPPER 3 BITS
ANDI LEDS, 0b11100000   ; MASK LOWER 5 BITS
ORI LEDS, R19  ; LOWER 5 BITS HAVE COUNTER BITS, UPPER 3 UNCHANGED
OUT PORTC, LEDS
CALL DELAY200
RJMP MAIN

DONE:
    RJMP DONE   ;SHOULD NEVER GET HERE

DELAY200:
LDI R24, 200
LOOP:
DEC R24
BRNE LOOP
RET

EXTERNAL_INTERUPT:
LDI R23, 0b10000000
EOR LEDS, R23   ;TOGGLE 7TH BIT
OUT PORTC, LEDS
RETI

TIMER1_INTERUPT:
LDI R23, 0b01000000
EOR LEDS, R23   ;TOGGLE 6TH BIT
OUT PORTC, LEDS
RETI

